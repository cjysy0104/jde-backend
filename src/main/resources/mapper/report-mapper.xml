<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.jde.report.model.dao.ReportMapper">
	<!-- 댓글 신고 등록 -->
	<insert id="insertCommentReport" parameterType="CommentReportVO">
		INSERT
		  INTO
		       TB_COMMENT_REPORT (
		           COMMENT_REPORT_NO
		         , MEMBER_NO
		         , COMMENT_NO
		         , REPORT_CATEGORY_NO
		         , REPORT_CONTENT
		         , REPORT_PROCESS
		         , CREATED_AT
		         , UPDATE_AT
		         , STATUS
		       )
		VALUES
		       (
		       SEQ_COMMENT_REPORT_NO.NEXTVAL
		     , #{memberNo}
		     , #{commentNo}
		     , #{reportCategoryNo}
		     , #{reportContent}
		     , DEFAULT
		     , DEFAULT
		     , DEFAULT
		     , DEFAULT
		       )
	</insert>
	
	<!-- 리뷰 신고 등록 -->
	<insert id="insertReviewReport" parameterType="ReviewReportVO">
		INSERT
		  INTO
		       TB_REVIEW_REPORT 
		       (
		       REVIEW_REPORT_NO
		     , MEMBER_NO
		     , REVIEW_NO
		     , REPORT_CATEGORY_NO
		     , REPORT_CONTENT
		     , REPORT_PROCESS
		     , CREATED_AT
		     , UPDATE_AT
		     , STATUS
		       )
		VALUES
		       (
		       SEQ_REVIEW_REPORT_NO.NEXTVAL
		     , #{memberNo}
		     , #{reviewNo}
		     , #{reportCategoryNo}
		     , #{reportContent}
		     , DEFAULT
		     , DEFAULT
		     , DEFAULT
		     , DEFAULT
		       )
	</insert>
	
	<!-- 댓글 신고 중복 체크 -->
	<select id="countCommentReportByMemberAndComment" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_COMMENT_REPORT
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND 
		       COMMENT_NO = #{commentNo}
		   AND 
		       STATUS = 'Y'
	</select>
	
	<!-- 리뷰 신고 중복 체크 -->
	<select id="countReviewReportByMemberAndReview" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_REVIEW_REPORT
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND 
		       REVIEW_NO = #{reviewNo}
		   AND 
		       STATUS = 'Y'
	</select>
	
	<!-- 댓글 신고 전체 개수 조회 -->
	<select id="countAllCommentReports" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_COMMENT_REPORT
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 댓글 신고 페이징 조회 -->
	<select id="selectCommentReportList" resultType="CommentReportListDTO">
		SELECT
		       R.COMMENT_REPORT_NO commentReportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.COMMENT_NO commentNo
		     , C.REVIEW_NO reviewNo
		     , C.CONTENT commentContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       (
		       SELECT
		              COMMENT_REPORT_NO
		            , MEMBER_NO
		            , COMMENT_NO
		            , REPORT_CATEGORY_NO
		            , REPORT_CONTENT
		            , REPORT_PROCESS
		            , CREATED_AT
		            , UPDATE_AT
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     COMMENT_REPORT_NO
		                   , MEMBER_NO
		                   , COMMENT_NO
		                   , REPORT_CATEGORY_NO
		                   , REPORT_CONTENT
		                   , REPORT_PROCESS
		                   , CREATED_AT
		                   , UPDATE_AT
		                   , STATUS
		                FROM
		                     TB_COMMENT_REPORT
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     CREATED_AT DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_COMMENT C
		    ON R.COMMENT_NO = C.COMMENT_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       R.CREATED_AT DESC
	</select>
	
	<!-- 리뷰 신고 전체 개수 조회 -->
	<select id="countAllReviewReports" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_REVIEW_REPORT
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 리뷰 신고 페이징 조회 -->
	<select id="selectReviewReportList" resultType="ReviewReportListDTO">
		SELECT
		       R.REVIEW_REPORT_NO reviewReportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.REVIEW_NO reviewNo
		     , RV.CONTENT reviewContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       (
		       SELECT
		              REVIEW_REPORT_NO
		            , MEMBER_NO
		            , REVIEW_NO
		            , REPORT_CATEGORY_NO
		            , REPORT_CONTENT
		            , REPORT_PROCESS
		            , CREATED_AT
		            , UPDATE_AT
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     REVIEW_REPORT_NO
		                   , MEMBER_NO
		                   , REVIEW_NO
		                   , REPORT_CATEGORY_NO
		                   , REPORT_CONTENT
		                   , REPORT_PROCESS
		                   , CREATED_AT
		                   , UPDATE_AT
		                   , STATUS
		                FROM
		                     TB_REVIEW_REPORT
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     CREATED_AT DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_REVIEW RV
		    ON R.REVIEW_NO = RV.REVIEW_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       R.CREATED_AT DESC
	</select>

</mapper>
