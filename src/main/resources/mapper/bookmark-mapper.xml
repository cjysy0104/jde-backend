<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.jde.bookmark.model.dao.BookmarkMapper">

    <!-- 북마크 존재 여부: 0/1 판단용 -->
    <select id="countBookmark"
            parameterType="com.kh.jde.bookmark.model.vo.BookmarkVO"
            resultType="int">
        SELECT 
               COUNT(*)
          FROM 
               TB_BOOKMARK
         WHERE 
               MEMBER_NO = #{memberNo}
           AND 
               REVIEW_NO = #{reviewNo}
    </select>

    <!-- 북마크 추가 (중복 방지: NOT EXISTS) -->
    <insert id="createBookmarkIgnoreDuplicate"
            parameterType="com.kh.jde.bookmark.model.vo.BookmarkVO">
        INSERT 
          INTO 
               TB_BOOKMARK 
               (
               MEMBER_NO
             , REVIEW_NO
             , ENROLL_DATE
               )
        SELECT 
               #{memberNo}
             , #{reviewNo}
             , SYSDATE
          FROM 
               dual
         WHERE 
          NOT EXISTS (
            		 SELECT 
            		        1
            		   FROM 
            		        TB_BOOKMARK
            		  WHERE 
            		        MEMBER_NO = #{memberNo}
              			AND 
              			    REVIEW_NO = #{reviewNo}
        			  )
    </insert>

    <!-- 북마크 삭제 -->
    <delete id="deleteBookmark"
            parameterType="com.kh.jde.bookmark.model.vo.BookmarkVO">
        DELETE 
          FROM 
               TB_BOOKMARK
         WHERE 
               MEMBER_NO = #{memberNo}
           AND 
               REVIEW_NO = #{reviewNo}
    </delete>

    <!-- 내 북마크 목록 조회 (좋아요 수/댓글 수/썸네일 1장 포함) -->
    <select id="selectMyBookmarks"
	        parameterType="com.kh.jde.bookmark.model.vo.BookmarkVO"
	        resultType="com.kh.jde.bookmark.model.dto.BookmarkResponseDTO">
	
	    SELECT
	           reviewNo
	         , bookmarkEnrollDate
	         , content
	         , rating
	         , reviewCreatedAt
	         , writerMemberNo
	         , writerNickname
	         , likeCount
	         , commentCount
	         , thumbnailUrl
	         , restaurantName
	      FROM (
	           SELECT
	            	  t.reviewNo
	            	, t.bookmarkEnrollDate
	            	, t.content
	            	, t.rating
	            	, t.reviewCreatedAt
	            	, t.writerMemberNo
	            	, t.writerNickname
	            	, t.likeCount
	            	, t.commentCount
	            	, t.thumbnailUrl
	            	, t.restaurantName
	            	, ROWNUM rn
	             FROM 
	                  (
	            	  SELECT
	               			 b.REVIEW_NO   AS reviewNo
	               		   , b.ENROLL_DATE AS bookmarkEnrollDate
	               		   , r.CONTENT     AS content
	               		   
	               		   , r.RATING      AS rating
	               		   , r.CREATED_AT  AS reviewCreatedAt
	               		   , r.MEMBER_NO   AS writerMemberNo
	               		   , m.NICKNAME    AS writerNickname
	               		   , rt.NORMAL_NAME AS restaurantName
	               		   , (
	               		     SELECT 
	               		            COUNT(*)
	                   		   FROM 
	                   		        TB_REVIEW_LIKE rl
	                 		  WHERE 
	                 		        rl.REVIEW_NO = r.REVIEW_NO
	                 		  ) AS likeCount
	                 		, (
	                 		  SELECT 
	                 		         COUNT(*)
	                   			FROM 
	                   			     TB_COMMENT c
	                  		   WHERE 
	                  		         c.REVIEW_NO = r.REVIEW_NO
	                   			 AND 
	                   			     c.STATUS = 'Y'
	                   		  ) AS commentCount
	                   		, (
	                   		  SELECT 
	                   		         rf.FILE_URL
					   			FROM 
					   			     TB_REVIEW_FILE rf
					  		   WHERE 
					  		         rf.REVIEW_NO = r.REVIEW_NO
					    		 AND 
					    		     rf.IS_THUMNAIL = 'Y'
					  		   ORDER 
					  		      BY 
					  		         rf.SORT_ORDER ASC
					  		       , rf.FILE_NO ASC
					  		   FETCH FIRST 1 ROWS ONLY
					  		  ) AS thumbnailUrl
	            		 FROM 
	            		      TB_BOOKMARK b
	            		 JOIN 
	            		      TB_REVIEW r ON r.REVIEW_NO = b.REVIEW_NO
	            		 JOIN 
	            		      TB_MEMBER m ON m.MEMBER_NO = r.MEMBER_NO
	            		 JOIN TB_RESTAURANT rt
                   		   ON rt.RESTAURANT_NO = r.RESTAURANT_NO
	            		WHERE 
	            		      b.MEMBER_NO = #{memberNo}
	              		  AND 
	              		      r.STATUS = 'Y'
	            		ORDER 
	            		   BY 
	            		      b.ENROLL_DATE DESC
	            		    , b.REVIEW_NO DESC
	        		   ) t
	        	 WHERE 
	        	       ROWNUM &lt;= (#{offset} + #{size})
	    		)
	      WHERE 
	            rn > #{offset}
	
	</select>

</mapper>
