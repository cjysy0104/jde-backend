<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.jde.bookmark.model.dao.BookmarkMapper">

    <!-- 북마크 존재 여부: 0/1 판단용 -->
    <select id="countBookmark"
            parameterType="com.kh.jde.bookmark.model.vo.BookmarkVO"
            resultType="int">
        SELECT COUNT(*)
        FROM TB_BOOKMARK
        WHERE MEMBER_NO = #{memberNo}
          AND REVIEW_NO = #{reviewNo}
    </select>

    <!-- 북마크 추가 (MERGE 없이 중복 방지: NOT EXISTS) -->
    <insert id="insertBookmarkIgnoreDuplicate"
            parameterType="com.kh.jde.bookmark.model.vo.BookmarkVO">
        INSERT INTO TB_BOOKMARK (MEMBER_NO, REVIEW_NO, ENROLL_DATE)
        SELECT #{memberNo}, #{reviewNo}, SYSDATE
        FROM dual
        WHERE NOT EXISTS (
            SELECT 1
            FROM TB_BOOKMARK
            WHERE MEMBER_NO = #{memberNo}
              AND REVIEW_NO = #{reviewNo}
        )
    </insert>

    <!-- 북마크 삭제 -->
    <delete id="deleteBookmark"
            parameterType="com.kh.jde.bookmark.model.vo.BookmarkVO">
        DELETE FROM TB_BOOKMARK
        WHERE MEMBER_NO = #{memberNo}
          AND REVIEW_NO = #{reviewNo}
    </delete>

    <!-- 내 북마크 목록 조회 (좋아요 수/댓글 수/썸네일 1장 포함) -->
    <select id="selectMyBookmarks" resultType="com.kh.jde.bookmark.model.dto.BookmarkResponseDTO">
        SELECT
            b.REVIEW_NO   AS reviewNo,
            b.ENROLL_DATE AS bookmarkEnrollDate,

            r.CONTENT     AS content,
            r.RATING      AS rating,
            r.CREATED_AT  AS reviewCreatedAt,

            m.MEMBER_NO   AS writerMemberNo,
            m.NICKNAME    AS writerNickname,

            NVL(lk.likeCount, 0)    AS likeCount,
            NVL(cm.commentCount, 0) AS commentCount,

            rf.thumbnailUrl AS thumbnailUrl
        FROM TB_BOOKMARK b
        JOIN TB_REVIEW r
          ON r.REVIEW_NO = b.REVIEW_NO
         AND r.STATUS = 'Y'
        JOIN TB_MEMBER m
          ON m.MEMBER_NO = r.MEMBER_NO

        LEFT JOIN (
            SELECT REVIEW_NO, COUNT(*) AS likeCount
            FROM TB_REVIEW_LIKE
            GROUP BY REVIEW_NO
        ) lk
          ON lk.REVIEW_NO = r.REVIEW_NO

        LEFT JOIN (
            SELECT REVIEW_NO, COUNT(*) AS commentCount
            FROM TB_COMMENT
            WHERE STATUS = 'Y'
            GROUP BY REVIEW_NO
        ) cm
          ON cm.REVIEW_NO = r.REVIEW_NO

        LEFT JOIN (
            SELECT
                REVIEW_NO,
                MAX(FILE_URL) KEEP (
                    DENSE_RANK FIRST
                    ORDER BY CASE WHEN IS_THUMNAIL = 'Y' THEN 0 ELSE 1 END,
                             SORT_ORDER,
                             FILE_NO
                ) AS thumbnailUrl
            FROM TB_REVIEW_FILE
            GROUP BY REVIEW_NO
        ) rf
          ON rf.REVIEW_NO = r.REVIEW_NO

        WHERE b.MEMBER_NO = #{memberNo}

        ORDER BY b.ENROLL_DATE DESC, b.REVIEW_NO DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>


</mapper>
