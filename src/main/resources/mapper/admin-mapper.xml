<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.jde.admin.model.dao.AdminMapper">
	
	<!-- 댓글 신고 전체 개수 조회 -->
	<select id="countAllCommentReports" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_COMMENT_REPORT
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 댓글 신고 페이징 조회 -->
	<select id="selectCommentReportList" resultType="CommentReportListDTO">
		SELECT
		       R.COMMENT_REPORT_NO commentReportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.COMMENT_NO commentNo
		     , C.REVIEW_NO reviewNo
		     , C.CONTENT commentContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       (
		       SELECT
		              COMMENT_REPORT_NO
		            , MEMBER_NO
		            , COMMENT_NO
		            , REPORT_CATEGORY_NO
		            , REPORT_CONTENT
		            , REPORT_PROCESS
		            , CREATED_AT
		            , UPDATE_AT
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     COMMENT_REPORT_NO
		                   , MEMBER_NO
		                   , COMMENT_NO
		                   , REPORT_CATEGORY_NO
		                   , REPORT_CONTENT
		                   , REPORT_PROCESS
		                   , CREATED_AT
		                   , UPDATE_AT
		                   , STATUS
		                FROM
		                     TB_COMMENT_REPORT
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     CREATED_AT DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_COMMENT C
		    ON R.COMMENT_NO = C.COMMENT_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       R.CREATED_AT DESC
	</select>
	
	<!-- 리뷰 신고 전체 개수 조회 -->
	<select id="countAllReviewReports" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_REVIEW_REPORT
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 리뷰 신고 페이징 조회 -->
	<select id="selectReviewReportList" resultType="ReviewReportListDTO">
		SELECT
		       R.REVIEW_REPORT_NO reviewReportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.REVIEW_NO reviewNo
		     , RV.CONTENT reviewContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       (
		       SELECT
		              REVIEW_REPORT_NO
		            , MEMBER_NO
		            , REVIEW_NO
		            , REPORT_CATEGORY_NO
		            , REPORT_CONTENT
		            , REPORT_PROCESS
		            , CREATED_AT
		            , UPDATE_AT
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     REVIEW_REPORT_NO
		                   , MEMBER_NO
		                   , REVIEW_NO
		                   , REPORT_CATEGORY_NO
		                   , REPORT_CONTENT
		                   , REPORT_PROCESS
		                   , CREATED_AT
		                   , UPDATE_AT
		                   , STATUS
		                FROM
		                     TB_REVIEW_REPORT
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     CREATED_AT DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_REVIEW RV
		    ON R.REVIEW_NO = RV.REVIEW_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       R.CREATED_AT DESC
	</select>
	
	<!-- 댓글 신고 상세 조회 -->
	<select id="selectCommentReportByNo" resultType="CommentReportListDTO">
		SELECT
		       R.COMMENT_REPORT_NO commentReportNo
		     , R.COMMENT_REPORT_NO reportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.COMMENT_NO commentNo
		     , C.REVIEW_NO reviewNo
		     , C.CONTENT commentContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       TB_COMMENT_REPORT R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_COMMENT C
		    ON R.COMMENT_NO = C.COMMENT_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       R.COMMENT_REPORT_NO = #{reportNo}
		   AND R.STATUS = 'Y'
	</select>
	
	<!-- 댓글 신고 상세 조회 (처리 후 조회용 - STATUS 조건 없음) -->
	<select id="selectCommentReportByNoAfterProcess" resultType="CommentReportListDTO">
		SELECT
		       R.COMMENT_REPORT_NO commentReportNo
		     , R.COMMENT_REPORT_NO reportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.COMMENT_NO commentNo
		     , C.REVIEW_NO reviewNo
		     , C.CONTENT commentContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       TB_COMMENT_REPORT R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_COMMENT C
		    ON R.COMMENT_NO = C.COMMENT_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       R.COMMENT_REPORT_NO = #{reportNo}
	</select>
	
	<!-- 리뷰 신고 상세 조회 -->
	<select id="selectReviewReportByNo" resultType="ReviewReportListDTO">
		SELECT
		       R.REVIEW_REPORT_NO reviewReportNo
		     , R.REVIEW_REPORT_NO reportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.REVIEW_NO reviewNo
		     , RV.CONTENT reviewContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       TB_REVIEW_REPORT R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_REVIEW RV
		    ON R.REVIEW_NO = RV.REVIEW_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       R.REVIEW_REPORT_NO = #{reportNo}
		   AND R.STATUS = 'Y'
	</select>
	
	<!-- 리뷰 신고 상세 조회 (처리 후 조회용 - STATUS 조건 없음) -->
	<select id="selectReviewReportByNoAfterProcess" resultType="ReviewReportListDTO">
		SELECT
		       R.REVIEW_REPORT_NO reviewReportNo
		     , R.REVIEW_REPORT_NO reportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.REVIEW_NO reviewNo
		     , RV.CONTENT reviewContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       TB_REVIEW_REPORT R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_REVIEW RV
		    ON R.REVIEW_NO = RV.REVIEW_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       R.REVIEW_REPORT_NO = #{reportNo}
	</select>
	
	<!-- 댓글 신고 처리 업데이트 -->
	<update id="updateCommentReportProcess" parameterType="CommentReportProcessDTO">
		UPDATE
		       TB_COMMENT_REPORT
		   SET
		       REPORT_PROCESS = #{reportProcess}
		     , UPDATE_AT = SYSDATE
		     , STATUS = CASE 
		                    WHEN #{reportProcess} IN ('RESOLVED', 'REJECTED') THEN 'N'
		                    ELSE STATUS
		                 END
		 WHERE
		       COMMENT_REPORT_NO = #{reportNo}
		   AND 
		       STATUS = 'Y'
	</update>
	
	<!-- 리뷰 신고 처리 업데이트 -->
	<update id="updateReviewReportProcess" parameterType="ReviewReportProcessDTO">
		UPDATE
		       TB_REVIEW_REPORT
		   SET
		       REPORT_PROCESS = #{reportProcess}
		     , UPDATE_AT = SYSDATE
		     , STATUS = CASE 
		                    WHEN #{reportProcess} IN ('RESOLVED', 'REJECTED') THEN 'N'
		                    ELSE STATUS
		                 END
		 WHERE
		       REVIEW_REPORT_NO = #{reportNo}
		   AND 
		       STATUS = 'Y'
	</update>
	
	<!-- 회원 전체 개수 조회 -->
	<select id="countAllMembers" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_MEMBER
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 회원 페이징 조회 (개인정보 마스킹) -->
	<select id="selectMemberList" resultType="MemberListDTO">
		SELECT
		       MEMBER_NO memberNo
		     , CASE 
		            WHEN LENGTH(EMAIL) &lt;= 4 OR INSTR(EMAIL, '@') = 0 THEN EMAIL
		            WHEN INSTR(EMAIL, '@') - 1 &lt;= 4 THEN EMAIL
		            ELSE SUBSTR(EMAIL, 1, 2) || '****' || SUBSTR(EMAIL, INSTR(EMAIL, '@') - 2) || '@' || SUBSTR(EMAIL, INSTR(EMAIL, '@') + 1)
		       END email
		     , CASE 
		            WHEN LENGTH(MEMBER_NAME) &lt;= 1 THEN MEMBER_NAME
		            WHEN LENGTH(MEMBER_NAME) = 2 THEN SUBSTR(MEMBER_NAME, 1, 1) || '*'
		            ELSE SUBSTR(MEMBER_NAME, 1, FLOOR(LENGTH(MEMBER_NAME)/2)) || '*' || SUBSTR(MEMBER_NAME, FLOOR(LENGTH(MEMBER_NAME)/2) + 2)
		       END memberName
		     , NICKNAME nickname
		     , CASE 
		            WHEN INSTR(PHONE, '-') = 0 THEN PHONE
		            ELSE SUBSTR(PHONE, 1, 3) || '-****-' || SUBSTR(PHONE, -4)
		       END phone
		     , ENROLL_DATE enrollDate
		     , STATUS status
		     , ROLE role
		  FROM
		       (
		       SELECT
		              MEMBER_NO
		            , EMAIL
		            , MEMBER_NAME
		            , NICKNAME
		            , PHONE
		            , ENROLL_DATE
		            , STATUS
		            , ROLE
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     MEMBER_NO
		                   , EMAIL
		                   , MEMBER_NAME
		                   , NICKNAME
		                   , PHONE
		                   , ENROLL_DATE
		                   , STATUS
		                   , ROLE
		                FROM
		                     TB_MEMBER
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     ENROLL_DATE DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       )
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       ENROLL_DATE DESC
	</select>
	
	<!-- 회원 상세 조회 (비밀번호 제외, 개인정보 마스킹) -->
	<select id="selectMemberByNo" resultType="MemberDetailDTO">
		SELECT
		       MEMBER_NO memberNo
		     , CASE 
		            WHEN LENGTH(EMAIL) &lt;= 4 OR INSTR(EMAIL, '@') = 0 THEN EMAIL
		            WHEN INSTR(EMAIL, '@') - 1 &lt;= 4 THEN EMAIL
		            ELSE SUBSTR(EMAIL, 1, 2) || '****' || SUBSTR(EMAIL, INSTR(EMAIL, '@') - 2) || '@' || SUBSTR(EMAIL, INSTR(EMAIL, '@') + 1)
		       END email
		     , CASE 
		            WHEN LENGTH(MEMBER_NAME) &lt;= 1 THEN MEMBER_NAME
		            WHEN LENGTH(MEMBER_NAME) = 2 THEN SUBSTR(MEMBER_NAME, 1, 1) || '*'
		            ELSE SUBSTR(MEMBER_NAME, 1, FLOOR(LENGTH(MEMBER_NAME)/2)) || '*' || SUBSTR(MEMBER_NAME, FLOOR(LENGTH(MEMBER_NAME)/2) + 2)
		       END memberName
		     , NICKNAME nickname
		     , CASE 
		            WHEN INSTR(PHONE, '-') = 0 THEN PHONE
		            ELSE SUBSTR(PHONE, 1, 3) || '-****-' || SUBSTR(PHONE, -4)
		       END phone
		     , ENROLL_DATE enrollDate
		     , STATUS status
		     , ROLE role
		  FROM
		       TB_MEMBER
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND STATUS = 'Y'
	</select>
	
	<!-- 회원 권한 변경 -->
	<update id="updateMemberRole" parameterType="MemberRoleUpdateDTO">
		UPDATE
		       TB_MEMBER
		   SET
		       ROLE = #{role}
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND STATUS = 'Y'
	</update>
	
	<!-- 회원 삭제 (STATUS를 'N'으로 변경) -->
	<update id="deleteMember">
		UPDATE
		       TB_MEMBER
		   SET
		       STATUS = 'N'
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND STATUS = 'Y'
	</update>
	
	<!-- 미식대장 랭킹 기준 변경 -->
	<update id="updateCaptainRankPolicy">
		UPDATE
		       TB_RANKING_POLICY
		   SET
		       TOP_N = #{topN}
		 WHERE
		       POLICY_CODE = 'CAPTAIN_RANK'
	</update>
	
	<!-- 댓글 전체 개수 조회 -->
	<select id="countAllComments" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_COMMENT
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 댓글 페이징 조회 -->
	<select id="selectCommentList" resultType="CommentListDTO">
		SELECT
		       C.COMMENT_NO commentNo
		     , C.MEMBER_NO memberNo
		     , C.AUTHOR author
		     , C.REVIEW_NO reviewNo
		     , C.CONTENT commentContent
		     , C.COMMENT_DATE commentDate
		     , C.STATUS status
		  FROM
		       (
		       SELECT
		              COMMENT_NO
		            , MEMBER_NO
		            , AUTHOR
		            , REVIEW_NO
		            , CONTENT
		            , COMMENT_DATE
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     COMMENT_NO
		                   , MEMBER_NO
		                   , AUTHOR
		                   , REVIEW_NO
		                   , CONTENT
		                   , COMMENT_DATE
		                   , STATUS
		                FROM
		                     TB_COMMENT
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     COMMENT_DATE DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) C
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       C.COMMENT_DATE DESC
	</select>
	
	<!-- 댓글 상세 조회 -->
	<select id="selectCommentByNo" resultType="CommentListDTO">
		SELECT
		       COMMENT_NO commentNo
		     , MEMBER_NO memberNo
		     , AUTHOR author
		     , REVIEW_NO reviewNo
		     , CONTENT commentContent
		     , COMMENT_DATE commentDate
		     , STATUS status
		  FROM
		       TB_COMMENT
		 WHERE
		       COMMENT_NO = #{commentNo}
		   AND STATUS = 'Y'
	</select>
	
	<!-- 댓글 삭제 (STATUS를 'N'으로 변경) -->
	<update id="deleteComment">
		UPDATE
		       TB_COMMENT
		   SET
		       STATUS = 'N'
		 WHERE
		       COMMENT_NO = #{commentNo}
		   AND STATUS = 'Y'
	</update>
	
	<!-- 리뷰 페이징 조회 -->
	<select id="selectReviewList" resultType="ReviewListDTO">
		SELECT
		       R.REVIEW_NO reviewNo
		     , R.MEMBER_NO memberNo
		     , R.RESTAURANT_NO restaurantNo
		     , RE.NORMAL_NAME normalName
		     , R.CONTENT reviewContent
		     , R.CREATED_AT createdAt
		     , R.STATUS status
		  FROM
		       (
		       SELECT
		              REVIEW_NO
		            , MEMBER_NO
		            , RESTAURANT_NO
		            , CONTENT
		            , CREATED_AT
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                      REVIEW_NO
		            		, MEMBER_NO
		            		, RESTAURANT_NO
		            		, CONTENT
		            		, CREATED_AT
		            		, STATUS
		            		, ROWNUM RNUM
		                FROM
		                     TB_REVIEW
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     CREATED_AT DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) 
		  R
		  LEFT JOIN
		       TB_RESTAURANT RE
		       ON RE.RESTAURANT_NO = R.RESTAURANT_NO
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       R.CREATED_AT DESC
	</select>
	
	<!-- 리뷰 상세 조회 -->
	<select id="selectReviewByNo" resultType="ReviewListDTO">
		SELECT
		       R.REVIEW_NO reviewNo
		     , R.MEMBER_NO memberNo
		     , R.RESTAURANT_NO restaurantNo
		     , RE.NORMAL_NAME normalName
		     , R.CONTENT reviewContent
		     , R.CREATED_AT createdAt
		     , R.STATUS status
		  FROM
		       TB_REVIEW R
		  LEFT
		  JOIN
		  	   TB_RESTAURANT RE
		  	ON
		       R.RESTAURANT_NO = RE.RESTAURANT_NO
		 WHERE
		       REVIEW_NO = #{reviewNo}
		   AND STATUS = 'Y'
	</select>
	
	<!-- 리뷰 삭제 (STATUS를 'N'으로 변경) -->
	<update id="deleteReview">
		UPDATE
		       TB_REVIEW
		   SET
		       STATUS = 'N'
		 WHERE
		       REVIEW_NO = #{reviewNo}
		   AND STATUS = 'Y'
	</update>

</mapper>
