<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.jde.admin.model.dao.AdminMapper">
	
	<!-- 댓글 신고 전체 개수 조회 -->
	<select id="countAllCommentReports" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_COMMENT_REPORT
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 댓글 신고 페이징 조회 -->
	<select id="selectCommentReportList" resultType="CommentReportListDTO">
		SELECT
		       R.COMMENT_REPORT_NO commentReportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.COMMENT_NO commentNo
		     , C.REVIEW_NO reviewNo
		     , C.CONTENT commentContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       (
		       SELECT
		              COMMENT_REPORT_NO
		            , MEMBER_NO
		            , COMMENT_NO
		            , REPORT_CATEGORY_NO
		            , REPORT_CONTENT
		            , REPORT_PROCESS
		            , CREATED_AT
		            , UPDATE_AT
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     COMMENT_REPORT_NO
		                   , MEMBER_NO
		                   , COMMENT_NO
		                   , REPORT_CATEGORY_NO
		                   , REPORT_CONTENT
		                   , REPORT_PROCESS
		                   , CREATED_AT
		                   , UPDATE_AT
		                   , STATUS
		                FROM
		                     TB_COMMENT_REPORT
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     CREATED_AT DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_COMMENT C
		    ON R.COMMENT_NO = C.COMMENT_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       R.CREATED_AT DESC
	</select>
	
	<!-- 리뷰 신고 전체 개수 조회 -->
	<select id="countAllReviewReports" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_REVIEW_REPORT
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 리뷰 신고 페이징 조회 -->
	<select id="selectReviewReportList" resultType="ReviewReportListDTO">
		SELECT
		       R.REVIEW_REPORT_NO reviewReportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.REVIEW_NO reviewNo
		     , RV.CONTENT reviewContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       (
		       SELECT
		              REVIEW_REPORT_NO
		            , MEMBER_NO
		            , REVIEW_NO
		            , REPORT_CATEGORY_NO
		            , REPORT_CONTENT
		            , REPORT_PROCESS
		            , CREATED_AT
		            , UPDATE_AT
		            , STATUS
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     REVIEW_REPORT_NO
		                   , MEMBER_NO
		                   , REVIEW_NO
		                   , REPORT_CATEGORY_NO
		                   , REPORT_CONTENT
		                   , REPORT_PROCESS
		                   , CREATED_AT
		                   , UPDATE_AT
		                   , STATUS
		                FROM
		                     TB_REVIEW_REPORT
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     CREATED_AT DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       ) R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_REVIEW RV
		    ON R.REVIEW_NO = RV.REVIEW_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       R.CREATED_AT DESC
	</select>
	
	<!-- 댓글 신고 상세 조회 -->
	<select id="selectCommentReportByNo" resultType="CommentReportListDTO">
		SELECT
		       R.COMMENT_REPORT_NO commentReportNo
		     , R.COMMENT_REPORT_NO reportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.COMMENT_NO commentNo
		     , C.REVIEW_NO reviewNo
		     , C.CONTENT commentContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       TB_COMMENT_REPORT R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_COMMENT C
		    ON R.COMMENT_NO = C.COMMENT_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       R.COMMENT_REPORT_NO = #{reportNo}
		   AND R.STATUS = 'Y'
	</select>
	
	<!-- 리뷰 신고 상세 조회 -->
	<select id="selectReviewReportByNo" resultType="ReviewReportListDTO">
		SELECT
		       R.REVIEW_REPORT_NO reviewReportNo
		     , R.REVIEW_REPORT_NO reportNo
		     , R.MEMBER_NO memberNo
		     , M.NICKNAME memberNickname
		     , R.REVIEW_NO reviewNo
		     , RV.CONTENT reviewContent
		     , R.REPORT_CATEGORY_NO reportCategoryNo
		     , RC.REPORT_CATEGORY_TITLE reportCategoryTitle
		     , R.REPORT_CONTENT reportContent
		     , R.REPORT_PROCESS reportProcess
		     , R.CREATED_AT createdAt
		     , R.UPDATE_AT updateAt
		     , R.STATUS status
		  FROM
		       TB_REVIEW_REPORT R
		 INNER JOIN
		       TB_MEMBER M
		    ON R.MEMBER_NO = M.MEMBER_NO
		 INNER JOIN
		       TB_REVIEW RV
		    ON R.REVIEW_NO = RV.REVIEW_NO
		 INNER JOIN
		       TB_REPORT_CATEGORY RC
		    ON R.REPORT_CATEGORY_NO = RC.REPORT_CATEGORY_NO
		 WHERE
		       R.REVIEW_REPORT_NO = #{reportNo}
		   AND R.STATUS = 'Y'
	</select>
	
	<!-- 댓글 신고 처리 업데이트 -->
	<update id="updateCommentReportProcess" parameterType="CommentReportProcessDTO">
		UPDATE
		       TB_COMMENT_REPORT
		   SET
		       REPORT_PROCESS = #{reportProcess}
		     , UPDATE_AT = SYSDATE
		     , STATUS = CASE 
		                    WHEN #{reportProcess} IN ('RESOLVED', 'REJECTED') THEN 'N'
		                    ELSE STATUS
		                 END
		 WHERE
		       COMMENT_REPORT_NO = #{reportNo}
		   AND 
		       STATUS = 'Y'
	</update>
	
	<!-- 리뷰 신고 처리 업데이트 -->
	<update id="updateReviewReportProcess" parameterType="ReviewReportProcessDTO">
		UPDATE
		       TB_REVIEW_REPORT
		   SET
		       REPORT_PROCESS = #{reportProcess}
		     , UPDATE_AT = SYSDATE
		     , STATUS = CASE 
		                    WHEN #{reportProcess} IN ('RESOLVED', 'REJECTED') THEN 'N'
		                    ELSE STATUS
		                 END
		 WHERE
		       REVIEW_REPORT_NO = #{reportNo}
		   AND 
		       STATUS = 'Y'
	</update>
	
	<!-- 회원 전체 개수 조회 -->
	<select id="countAllMembers" resultType="int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_MEMBER
		 WHERE
		       STATUS = 'Y'
	</select>
	
	<!-- 회원 페이징 조회 -->
	<select id="selectMemberList" resultType="MemberListDTO">
		SELECT
		       MEMBER_NO memberNo
		     , EMAIL email
		     , MEMBER_NAME memberName
		     , NICKNAME nickname
		     , PHONE phone
		     , ENROLL_DATE enrollDate
		     , STATUS status
		     , ROLE role
		  FROM
		       (
		       SELECT
		              MEMBER_NO
		            , EMAIL
		            , MEMBER_NAME
		            , NICKNAME
		            , PHONE
		            , ENROLL_DATE
		            , STATUS
		            , ROLE
		            , ROWNUM RNUM
		         FROM
		              (
		              SELECT
		                     MEMBER_NO
		                   , EMAIL
		                   , MEMBER_NAME
		                   , NICKNAME
		                   , PHONE
		                   , ENROLL_DATE
		                   , STATUS
		                   , ROLE
		                FROM
		                     TB_MEMBER
		               WHERE
		                     STATUS = 'Y'
		               ORDER BY
		                     ENROLL_DATE DESC
		              )
		        WHERE
		              ROWNUM &lt;= #{offset} + #{boardLimit}
		       )
		 WHERE
		       RNUM &gt; #{offset}
		 ORDER BY
		       ENROLL_DATE DESC
	</select>
	
	<!-- 회원 상세 조회 (비밀번호 제외) -->
	<select id="selectMemberByNo" resultType="MemberDetailDTO">
		SELECT
		       MEMBER_NO memberNo
		     , EMAIL email
		     , MEMBER_NAME memberName
		     , NICKNAME nickname
		     , PHONE phone
		     , ENROLL_DATE enrollDate
		     , STATUS status
		     , ROLE role
		  FROM
		       TB_MEMBER
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND STATUS = 'Y'
	</select>
	
	<!-- 회원 권한 변경 -->
	<update id="updateMemberRole">
		UPDATE
		       TB_MEMBER
		   SET
		       ROLE = #{role}
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND STATUS = 'Y'
	</update>
	
	<!-- 회원 삭제 (STATUS를 'N'으로 변경) -->
	<update id="deleteMember">
		UPDATE
		       TB_MEMBER
		   SET
		       STATUS = 'N'
		 WHERE
		       MEMBER_NO = #{memberNo}
		   AND STATUS = 'Y'
	</update>

</mapper>
